<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:tracing="http://www.mulesoft.org/schema/mule/tracing"
      xmlns:kafka="http://www.mulesoft.org/schema/mule/kafka"
      xmlns:email="http://www.mulesoft.org/schema/mule/email"
      xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
      xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
      xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
        http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
        http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd
        http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd
http://www.mulesoft.org/schema/mule/kafka http://www.mulesoft.org/schema/mule/kafka/current/mule-kafka.xsd
http://www.mulesoft.org/schema/mule/tracing http://www.mulesoft.org/schema/mule/tracing/current/mule-tracing.xsd">

	 <configuration-properties
        doc:name="Application Properties"
        file="application-${mule.env}.properties"/>

    <!-- validation config -->
    <validation:config name="Validation_Config" doc:name="Validation Config" />

    <!-- Email SMTP config (STARTTLS) -->
    <email:smtp-config name="Email_SMTP" doc:name="Email SMTP">
        <email:smtp-connection
            host="smtp.gmail.com"
            port="587"
            user="${email.smtp.user}"
            password="${email.smtp.password}"
            connectionTimeout="10000"
            writeTimeout="10000"
            readTimeout="10000">
            <email:properties>
                <email:property key="mail.smtp.starttls.enable" value="true"/>
                <email:property key="mail.smtp.starttls.required" value="true"/>
                <email:property key="mail.smtp.auth" value="true"/>
            </email:properties>
        </email:smtp-connection>
    </email:smtp-config>

    <!-- ============================= -->
    <!--  PAYMENT SUMMARY FLOW         -->
    <!-- ============================= -->
   <kafka:consumer-config
        name="Apache_Kafka_Consumer_configuration"
        doc:name="Apache Kafka Consumer configuration">

    <kafka:consumer-plaintext-connection>
        <kafka:bootstrap-servers>
            <kafka:bootstrap-server value="localhost:9092"/>
        </kafka:bootstrap-servers>

        <kafka:topic-patterns>
            <kafka:topic-pattern value="pharmacy.payment.completed"/>
        </kafka:topic-patterns>

    </kafka:consumer-plaintext-connection>

</kafka:consumer-config>

<kafka:producer-config
        name="Apache_Kafka_Producer_configuration"
        doc:name="Apache Kafka Producer configuration">

    <kafka:producer-plaintext-connection>
        <kafka:bootstrap-servers>
            <kafka:bootstrap-server value="localhost:9092"/>
        </kafka:bootstrap-servers>
    </kafka:producer-plaintext-connection>

</kafka:producer-config>



	<http:listener-config name="Soap_insurance" doc:name="HTTP Listener config" doc:id="7aeb3e58-2e47-4317-a939-d3529b8a23e5" >
		<http:listener-connection host="0.0.0.0" port="8089" />
	</http:listener-config>
	<flow name="pharmacy_paymentFlow" doc:id="f118a727-c3fb-429a-8609-1e6053991bee">
    <http:listener doc:name="Payment Summary Listener" config-ref="HTTP_Listener_config"
                   path="/pharmacy/payment-summary" outputMimeType="application/json" allowedMethods="POST"/>

    <ee:transform doc:name="Normalize Payload">
        <ee:message><ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload
]]></ee:set-payload></ee:message>
    </ee:transform>

    <set-variable variableName="prescriptionId" value="#[payload.prescriptionId]" doc:name="Prescription ID"/>
    <set-variable variableName="patientId" value="#[payload.patientId]" doc:name="Patient ID"/>
    <set-variable variableName="patientName" value="#[payload.patientName]" doc:name="Patient Name"/>
    <set-variable variableName="patientEmail" value="#[payload.patientEmail]" doc:name="Patient Email"/>
    <set-variable variableName="items" value="#[payload.items]" doc:name="Prescription Items"/>

    <!-- call your existing validation flow -->
    <flow-ref name="pharmacy_ValidationFlow" doc:name="Validate Prescription Items"/>

    <ee:transform doc:name="Filter Available Items">
        <ee:message><ee:set-payload><![CDATA[%dw 2.0
output application/java
var validated = payload.validation default []
---
validated filter ((item) -> item.status == "AVAILABLE")
]]></ee:set-payload></ee:message>
    </ee:transform>

    <ee:transform doc:name="Calculate Total Amount">
        <ee:message><ee:set-payload><![CDATA[%dw 2.0
output application/java
var items = if (payload is Array) payload else [payload]
---
{
  payableItems: items map (i) -> {
    sku: i.sku,
    quantity: i.requestedQuantity,
    unitPrice: i.price,
    lineTotal: i.price * i.requestedQuantity
  },
  totalAmount: sum(items map (i) -> i.price * i.requestedQuantity)
}
]]></ee:set-payload></ee:message>
    </ee:transform>

    <!-- SAVE THE SUMMARY BEFORE CALLING INSURANCE -->
    <set-variable variableName="summary" value="#[payload]" doc:name="Save Summary Before Insurance"/>

    <!-- NOW CALL INSURANCE -->
    <flow-ref doc:name="Check Insurance Coverage" doc:id="4c1a54c0-5492-4fa9-ad17-042dec2bc735" name="insurance_CoverageFlow"/>
    
    <!-- COMBINE INSURANCE RESULT WITH SAVED SUMMARY -->
    <ee:transform doc:name="Apply Insurance Coverage">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/java

var insurance = payload
var summary = vars.summary
var original = summary.totalAmount

var discount =
    if (insurance.approved)
        (original * insurance.coveragePercentage / 100)
    else
        0
---
{
  payableItems: summary.payableItems,
  originalAmount: original,
  insuranceApplied: insurance.approved,
  coveragePercentage: insurance.coveragePercentage,
  discountAmount: discount,
  totalAmount: original - discount
}
]]></ee:set-payload>
        </ee:message>
    </ee:transform>

    <!-- NOW SAVE THE FINAL SUMMARY WITH INSURANCE APPLIED -->
    <set-variable variableName="finalSummary" value="#[payload]" doc:name="Load Final Summary"/>
    <set-variable variableName="purchaseId" value="#[uuid()]" doc:name="Purchase ID"/>

    <!-- Insert pending purchase log -->
    <db:insert doc:name="Insert Pending Purchase Log" config-ref="pharmacy_service" doc:id="ceb4a1e9-c816-45fa-aa4e-e2a5a0a86bcf">
        <db:sql><![CDATA[
INSERT INTO pharmacy_purchase_log
(id, purchase_id, patient_id, patient_name, patient_email, prescription_id, request_payload, response_payload, status)
VALUES (:id, :purchaseId, :patientId, :patientName, :patientEmail, :prescriptionId, :req, :res, 'PENDING')
]]></db:sql>
        <db:input-parameters><![CDATA[#[{
  id: uuid(),
  purchaseId: vars.purchaseId,
  patientId: vars.patientId,
  patientName: vars.patientName,
  patientEmail: vars.patientEmail,
  prescriptionId: vars.prescriptionId,
  req: write(vars.items, "application/json"),
  res: write(vars.finalSummary, "application/json")
}]]]></db:input-parameters>
    </db:insert>

    <ee:transform doc:name="Return Summary to Spring">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  purchaseId: vars.purchaseId,
  prescriptionId: vars.prescriptionId,
  patientId: vars.patientId,
  payableItems: vars.finalSummary.payableItems,
  originalAmount: vars.finalSummary.originalAmount,
  discountAmount: vars.finalSummary.discountAmount,
  totalAmount: vars.finalSummary.totalAmount,
  insuranceApplied: vars.finalSummary.insuranceApplied,
  coveragePercentage: vars.finalSummary.coveragePercentage,
  status: "PENDING"
}
]]></ee:set-payload>
        </ee:message>
    </ee:transform>

</flow>

    <!-- ============================= -->
    <!--  CONFIRM PAYMENT FLOW         -->
    <!-- ============================= -->
    <flow name="pharmacy_confirmPayment" doc:id="a47d6952-1951-4f5c-9561-6ae6433a560d">
        <http:listener doc:name="Confirm Payment Listener" config-ref="HTTP_Listener_config"
                       path="/pharmacy/confirm-payment/{purchaseId}" outputMimeType="application/json" allowedMethods="POST"/>

        <set-variable variableName="purchaseId" value="#[attributes.uriParams.purchaseId]" doc:name="Purchase ID"/>

        <db:select doc:name="Get Details from Purchase ID" config-ref="pharmacy_service" doc:id="7ec64d76-6268-4afc-9557-770bfb55d0cf">
            <db:sql><![CDATA[SELECT * FROM pharmacy_purchase_log WHERE purchase_id = :purchaseId]]></db:sql>
            <db:input-parameters><![CDATA[#[{ purchaseId: vars.purchaseId }]]]></db:input-parameters>
        </db:select>

        <set-variable value="#[payload[0].patient_id]" doc:name="Set PatientID" doc:id="e3f87a56-ae18-4fe4-8911-0f33da3a988e" variableName="patientId"/>
		<validation:is-not-null value="#[payload[0]]" message="Purchase ID not found or invalid" doc:name="Check Purchase ID excisting or Not"/>

        <!-- extract saved patient name / email (DB columns likely patient_name / patient_email) -->
        <validation:is-true doc:name='Check Status != "COMPLETED"' doc:id="8b8aa253-f376-4a08-bc3a-6c86fded80e4" expression="#[payload[0].status != 'COMPLETED']" message="Payment already completed for this purchase ID"/>
		<set-variable variableName="patientName" value="#[payload[0].patient_name]" doc:name="Patient Name"/>
        <set-variable variableName="patientEmail" value="#[payload[0].patient_email]" doc:name="Patient Email"/>

        <ee:transform doc:name="Get Payable Items &amp; Amount">
            <ee:message><ee:set-payload><![CDATA[%dw 2.0
output application/java
var row = payload[0] default {}
var stored = read(row.response_payload default "{}", "application/json")
---
{
    payableItems: stored.payableItems default [],
    totalAmount: stored.totalAmount default 0
}
]]></ee:set-payload></ee:message>
        </ee:transform>

        <set-variable variableName="payableItems" value="#[payload.payableItems]" doc:name="Payable Items"/>
        <set-variable variableName="totalAmount" value="#[payload.totalAmount]" doc:name="Total Amount"/>

        <foreach doc:name="For Each Item" collection="#[payload.payableItems]">
            <db:update doc:name="Update Stock For each Item" config-ref="pharmacy_service" doc:id="5675602b-4c3b-496b-b833-dbfd36e2c1dd">
                <db:sql><![CDATA[
UPDATE pharmacy_medicines SET stock = stock - :qty WHERE sku = :sku
]]></db:sql>
                <db:input-parameters><![CDATA[#[{ sku: payload.sku, qty: payload.quantity }]]]></db:input-parameters>
            </db:update>
        </foreach>

        <db:update doc:name="Update purchase_log" config-ref="pharmacy_service" doc:id="fcbd3479-3445-44f8-bd47-f635b5712752">
            <db:sql><![CDATA[UPDATE pharmacy_purchase_log SET status = 'COMPLETED' WHERE purchase_id = :purchaseId]]></db:sql>
            <db:input-parameters><![CDATA[#[{ purchaseId: vars.purchaseId }]]]></db:input-parameters>
        </db:update>

        <!-- Publish to Kafka: coerce patientName / patientEmail safely -->
        <kafka:publish doc:name="Publish" doc:id="9e732fa9-9649-4bc5-b088-af0c037ca96b" 
               config-ref="Apache_Kafka_Producer_configuration" 
               topic="pharmacy.payment.completed" 
               key="#[vars.purchaseId]">
    <kafka:message><![CDATA[#[output application/json --- {
        purchaseId: vars.purchaseId,
        patientId: vars.patientId,
        patientName: vars.patientName,
        patientEmail: vars.patientEmail,
        payableItems: vars.payableItems,
        totalAmount: vars.totalAmount,
        status: "COMPLETED"
    }]]]></kafka:message>
</kafka:publish>
		<logger level="INFO" message="Kafka Event Published for Purchase ID :  #[vars.purchaseId]" doc:name="Log Kafka Event publish" />

        <ee:transform doc:name="Return Summary to Spring">
            <ee:message><ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  purchaseId: vars.purchaseId,
  status: "COMPLETED",
  payableItems: vars.payableItems,
  totalAmount: vars.totalAmount
}
]]></ee:set-payload></ee:message>
        </ee:transform>
    </flow>

    <!-- ============================= -->
    <!--  EMAIL HANDLER  -->
    <!-- ============================= -->
<flow name="pharmacy-email-kafka-consumer">

    <kafka:message-listener
        config-ref="Apache_Kafka_Consumer_configuration"
        doc:name="Kafka Message Listener"/>

    <!-- Parse Kafka message -->
    <ee:transform doc:name="Parse Kafka Message">
        <ee:message>
            <ee:set-payload><![CDATA[
%dw 2.0
output application/java
---
read(payload, "application/json")
]]></ee:set-payload>
        </ee:message>
    </ee:transform>

    <try>

        <!-- OPTIONAL: force failure for testing -->
        <!-- <raise-error type="EMAIL:FORCED_FAILURE" description="Testing DLQ"/> -->

        <!-- Send email -->
        
       <!--    
       <raise-error type="APP:FORCED_FAILURE"
             description="Testing DLQ path"/>
        -->
        <email:send
            config-ref="Email_SMTP"
            fromAddress="kannan3807@gmail.com"
            subject="Your Pharmacy Purchase Receipt">

            <email:to-addresses>
                <email:to-address value="#[payload.patientEmail]"/>
            </email:to-addresses>

            <email:body contentType="text/plain" contentTransferEncoding="Binary">
					<email:content ><![CDATA[#[
        'Hello ' ++ payload.patientName ++ '\n\n' ++
        'Your payment has been successfully completed.\n\n' ++
        'Purchase ID: ' ++ payload.purchaseId ++ '\n' ++
        'Total Amount: Rs ' ++ (payload.totalAmount as String)
    ]]]></email:content>
</email:body>

        </email:send>

        <logger level="INFO"
                message="Email successfully sent to #[payload.patientEmail]"/>

        <error-handler>
            <on-error-continue logException="true">

                <logger level="ERROR"
                        message="Email failed, publishing to DLQ: #[error.description]"/>

                <kafka:publish
                    config-ref="Apache_Kafka_Producer_configuration"
                    topic="pharmacy.payment.email.dlq">

                    <kafka:message><![CDATA[
#[write({
    originalMessage: payload,
    errorMessage: error.description,
    failedAt: now(),
    service: "pharmacy-email-service"
}, "application/json")]
]]></kafka:message>

                </kafka:publish>

            </on-error-continue>
        </error-handler>

    </try>

</flow>

</mule>