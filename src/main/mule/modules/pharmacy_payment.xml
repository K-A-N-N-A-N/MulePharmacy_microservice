<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" 
      xmlns:db="http://www.mulesoft.org/schema/mule/db"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:http="http://www.mulesoft.org/schema/mule/http" 
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">

    
    <validation:config name="Validation_Config" doc:name="Validation Config" doc:id="5c149144-af4b-4228-bd6f-4780542022a0" />
	<flow name="pharmacy_paymentFlow" doc:id="0780238c-16d7-4d8b-8612-62a2a916acd0">

        <!-- 1. Listener -->
        <http:listener 
            doc:name="Payment Summary Listener" 
            config-ref="HTTP_Listener_config"
            path="/pharmacy/payment-summary"
            outputMimeType="application/json"
            allowedMethods="POST"/>

        <!-- 2. Normalize Payload -->
        <ee:transform doc:name="Normalize Payload">
            <ee:message>
                <ee:set-payload><![CDATA[
%dw 2.0
output application/java
---
payload
                ]]></ee:set-payload>
            </ee:message>
        </ee:transform>

        <!-- 3. Extract variables -->
        <set-variable variableName="prescriptionId" value="#[payload.prescriptionId]" doc:name="Prescription ID"/>
        <set-variable variableName="patientId" value="#[payload.patientId]" doc:name="Patient ID"/>
        <set-variable variableName="items" value="#[payload.items]" doc:name="Prescription Items"/>

        <!-- 4. Call existing validation flow -->
        <flow-ref name="pharmacy_ValidationFlow" doc:id="ca3209e8-9fe1-4e57-a11b-a807af345d33" doc:name="Validate Prescription Items"/>

        <!-- 5. Filter AVAILABLE items -->
<ee:transform doc:name="Filter Available Items" doc:id="8612650c-d30e-4b35-99a9-b88d31d19578" >
    <ee:message >
        <ee:set-payload ><![CDATA[%dw 2.0
output application/java
var validated = payload.validation default []
---
validated filter ((item) -> item.status == "AVAILABLE")
]]></ee:set-payload>
    </ee:message>
</ee:transform>
		
		<!-- 6. Compute totals -->
<ee:transform doc:name="Calculate Total Amount" doc:id="31930eee-0866-452e-b5ea-3fe89e998106" >
    <ee:message >
        <ee:set-payload ><![CDATA[%dw 2.0
output application/java

var items = 
    if (payload is Array) payload
    else [payload]

---
{
    payableItems: items map ((i) -> {
        sku: i.sku,
        quantity: i.requestedQuantity,
        unitPrice: i.price,
        lineTotal: i.price * i.requestedQuantity
    }),
    totalAmount: sum(items map ((i) -> i.price * i.requestedQuantity))
}
]]></ee:set-payload>
    </ee:message>
</ee:transform>
		
		<!-- 7. Create purchaseId -->
		<set-variable value="#[payload]" doc:name="Load Summary" doc:id="3aa4d814-4f5a-4234-8aa4-1c8f352b348c" variableName="summary"/>
		<set-variable variableName="purchaseId" value="#[uuid()]" doc:name="Purchase ID"/>

        <!-- 8. Insert summary into DB -->
        <db:insert doc:name="Insert Pending Purchase Log" config-ref="pharmacy_service">
            <db:sql><![CDATA[
INSERT INTO pharmacy_purchase_log
(id, purchase_id, patient_id, prescription_id, request_payload, response_payload, status)
VALUES
(:id, :purchaseId, :patientId, :prescriptionId, :req, :res, 'PENDING')
            ]]></db:sql>

            <db:input-parameters><![CDATA[#[{
    id: uuid(),
    purchaseId: vars.purchaseId,
    patientId: vars.patientId,
    prescriptionId: vars.prescriptionId,
    req: write(vars.items, 'application/json'),
    res: write(vars.summary, 'application/json')
}]]]></db:input-parameters>
        </db:insert>

        <!-- 9. Final Response -->
        <ee:transform doc:name="Return Summary to Spring">
    <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    purchaseId: vars.purchaseId,
    prescriptionId: vars.prescriptionId,
    patientId: vars.patientId,
    payableItems: vars.summary.payableItems,
    totalAmount: vars.summary.totalAmount,
    status: "PENDING"
}
]]></ee:set-payload>
    </ee:message>
</ee:transform>

<error-handler>
    <on-error-continue enableNotifications="true" logException="true" doc:name="DB Connectivity Error" type="DB:CONNECTIVITY">
        <flow-ref doc:name="Handle DB Connectivity" name="handle-db-connectivity-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="DB Query Error" type="DB:QUERY_EXECUTION">
        <flow-ref doc:name="Handle DB Query Error" name="handle-db-query-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="Transformation Error" type="MULE:TRANSFORMATION">
        <flow-ref doc:name="Handle Transformation Error" name="handle-transformation-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="Expression Error" type="MULE:EXPRESSION">
        <flow-ref doc:name="Handle Bad Request" name="handle-bad-request-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="Generic Error" type="ANY">
        <flow-ref doc:name="Handle Generic Error" name="handle-generic-error"/>
    </on-error-continue>
</error-handler>

    </flow>
	<flow name="pharmacy_confirmPayment" doc:id="0392de02-b2b0-4b0d-9e71-47c5e522da17" >
		<http:listener doc:name="Confirm Payment Listener" doc:id="93646c42-c994-40a8-9b2b-316707fc867b" config-ref="HTTP_Listener_config" path="/pharmacy/confirm-payment/{purchaseId}" outputMimeType="application/json" allowedMethods="POST"/>
		<set-variable value="#[attributes.uriParams.purchaseId]" doc:name="Purchase ID" doc:id="898766ee-fb2f-4b3c-8835-56f684d982b9" variableName="purchaseId"/>
		
		<!-- TRY SCOPE: Fetch and Validate Purchase -->
		<db:select doc:name="Get Details from Purchase ID" doc:id="009fa53a-fd58-44d6-95eb-b242202d2c1b" config-ref="pharmacy_service">
				<db:sql><![CDATA[SELECT * FROM pharmacy_purchase_log WHERE purchase_id = :purchaseId]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	purchaseId: vars.purchaseId
}]]]></db:input-parameters>
			</db:select>
		<set-variable value="#[payload.purchase_id]" doc:name="Store purchaseID from the DB" doc:id="d2eff1b4-f51a-4fe2-b69e-64fbe5acd55d" variableName="FOUND"/>
		<validation:is-not-null doc:name="Raise Invalid Purchase ID" doc:id="8641910f-893f-463e-b83f-3aff3f1312d9" config-ref="Validation_Config" value="#[vars.FOUND]" message="Purchase ID not found or invalid"/>
		
		<ee:transform doc:name="Get Payable Items &amp; Amount" doc:id="cbb49a7a-9af2-4138-b294-1ae8868dc2fa" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
var row = payload[0] default {}
var stored = read(row.response_payload default "{}", "application/json")
---
{
    payableItems: stored.payableItems default [],
    totalAmount: stored.totalAmount default 0
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<set-variable value="#[payload.payableItems]" doc:name="Payable Items" doc:id="b05c5eac-3746-4a94-a7cb-fb8f201d962c" variableName="payableItems"/>
		<set-variable value="#[payload.totalAmount]" doc:name="Total Amount" doc:id="6896f291-5c95-412a-b061-ecd4aee0d564" variableName="totalAmount"/>
		<foreach doc:name="For Each" doc:id="73d21756-5c1c-490d-93c4-a199dce66414" collection="#[payload.payableItems]">
			<db:update doc:name="Update Stock For each Item" doc:id="7acc12da-1e12-47ab-811e-fb02d4042185" config-ref="pharmacy_service">
				<db:sql ><![CDATA[UPDATE pharmacy_medicines
SET stock = stock - :qty
WHERE sku = :sku]]></db:sql>
				<db:input-parameters ><![CDATA[#[{
	sku: payload.sku,
	qty: payload.quantity,
}]]]></db:input-parameters>
			</db:update>
		</foreach>
		<db:update doc:name="Update purchase_log" doc:id="04901552-a1e4-4528-8d98-841281ccb92d" config-ref="pharmacy_service">
			<db:sql ><![CDATA[UPDATE pharmacy_purchase_log
SET status = 'COMPLETED'
WHERE purchase_id = :purchaseId]]></db:sql>
			<db:input-parameters ><![CDATA[#[{
	purchaseId: vars.purchaseId
}]]]></db:input-parameters>
		</db:update>
		<ee:transform doc:name="Return Summary to Spring" doc:id="1df6583b-d062-4902-ac29-acc19d890bde" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    purchaseId: vars.purchaseId,
    status: "COMPLETED",
    payableItems: vars.payableItems,
    totalAmount: vars.totalAmount
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		
		<error-handler>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="DB Connectivity Error" type="DB:CONNECTIVITY">
        <flow-ref doc:name="Handle DB Connectivity" name="handle-db-connectivity-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="DB Query Error" type="DB:QUERY_EXECUTION">
        <flow-ref doc:name="Handle DB Query Error" name="handle-db-query-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="Transformation Error" type="MULE:TRANSFORMATION">
        <flow-ref doc:name="Handle Transformation Error" name="handle-transformation-error"/>
    </on-error-continue>
    
    <on-error-continue enableNotifications="true" logException="true" doc:name="Generic Error" type="ANY">
        <flow-ref doc:name="Handle Generic Error" name="handle-generic-error"/>
    </on-error-continue>
</error-handler>
		
	</flow>


</mule>